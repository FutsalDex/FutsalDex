rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    // Checks if the requesting user is an admin.
    function isAdmin() {
      // Check if the user document exists and if the role field is 'admin'.
      return exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.role == 'admin';
    }

    // Checks if the requesting user is the owner of the document.
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }


    // --- Collection Rules ---

    // Ejercicios: Publicly readable, admin-only writable.
    match /ejercicios_futsal/{ejercicioId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Usuarios: Users can manage their own data. Admins can manage any user.
    match /usuarios/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();

      // Subcollections: users can manage their own subcollections.
      match /{subcollection}/{docId} {
         allow read, write: if isOwner(userId) || isAdmin();
      }
    }
    
    // Mis Sesiones: Users can manage their own sessions. Admins have full access.
    match /mis_sesiones/{sesionId} {
      allow read, create, update, delete: if isOwner(get(/databases/$(database)/documents/mis_sesiones/$(sesionId)).data.userId) || isAdmin();
    }
    
    // Partidos y Estad√≠sticas: Users can manage their own matches. Admins have full access.
    match /partidos_estadisticas/{partidoId} {
       allow read, create, update, delete: if isOwner(get(/databases/$(database)/documents/partidos_estadisticas/$(partidoId)).data.userId) || isAdmin();
    }

    // Support Chats: Users can manage their own chats. Admins have full access.
    match /support_chats/{chatId} {
       allow read, create, update, delete: if isOwner(get(/databases/$(database)/documents/support_chats/$(chatId)).data.userId) || isAdmin();
    }
  }
}

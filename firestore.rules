
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Regla general: por defecto, nadie puede leer o escribir.
    match /{document=**} {
      allow read, write: if false;
    }
    
    // EJERCICIOS: Cualquiera puede leerlos (para la biblioteca p√∫blica)
    // Solo los administradores pueden crearlos, actualizarlos o borrarlos.
    match /ejercicios_futsal/{exerciseId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.role == 'admin';
    }

    // DATOS DE USUARIO:
    // Un usuario solo puede leer y escribir su propio documento.
    // Un administrador puede leer y escribir CUALQUIER documento de usuario.
    match /usuarios/{userId} {
      allow read, update, delete: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId;
      
      // Permitir a los administradores gestionar usuarios
      allow read, write: if request.auth != null && get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.role == 'admin';
    }

    // FAVORITOS DE USUARIO:
    // Un usuario solo puede gestionar su propia lista de favoritos.
    match /usuarios/{userId}/user_favorites/{exerciseId} {
      allow read, write: if request.auth.uid == userId;
    }
    
    // SESIONES GUARDADAS:
    // Un usuario solo puede gestionar sus propias sesiones.
    match /mis_sesiones/{sessionId} {
      allow read, write, delete: if request.auth.uid == resource.data.userId;
      allow create: if request.auth.uid == request.resource.data.userId;
    }
    
    // ESTADISTICAS DE PARTIDOS:
    // Un usuario solo puede gestionar sus propios partidos.
    match /partidos_estadisticas/{matchId} {
       allow read, write, delete: if request.auth.uid == resource.data.userId;
       allow create: if request.auth.uid == request.resource.data.userId;
    }
    
    // PLANTILLA DE EQUIPO:
    // Un usuario solo puede gestionar su propia plantilla.
    match /usuarios/{userId}/team/{document=**} {
      allow read, write: if request.auth.uid == userId;
    }

    // CHATS DE SOPORTE:
    // Un usuario solo puede gestionar sus propios chats.
    match /support_chats/{chatId} {
      allow read, write: if request.auth.uid == resource.data.userId;
      allow create: if request.auth.uid == request.resource.data.userId;
    }
  }
}


rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regla 1: Denegar todo por defecto para máxima seguridad.
    match /{document=**} {
      allow read, write: if false;
    }

    // Regla 2: La colección de ejercicios es de lectura pública para todos.
    // La escritura se gestiona a través del panel de admin con el SDK de servidor,
    // que ignora estas reglas. Por tanto, la escritura desde el cliente está denegada.
    match /ejercicios_futsal/{exerciseId} {
      allow read: if true;
      allow write: if false;
    }

    // Regla 3: Un usuario puede leer y actualizar su propio documento de usuario.
    // La creación se permite si el UID del usuario coincide con el ID del documento.
    match /usuarios/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
    }

    // Regla 4: Un usuario puede gestionar todos los documentos en sus propias subcolecciones.
    // Esto cubre 'mis_sesiones', 'partidos_estadisticas', 'user_favorites', y la subcolección 'team'.
    match /usuarios/{userId}/{subcollection}/{docId} {
      allow read, write, delete: if request.auth != null && request.auth.uid == userId;
    }
  }
}
